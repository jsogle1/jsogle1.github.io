<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moon Phase Calculator</title>

  <style>
    body {
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1rem;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.45;
    }

    h1, h2 { line-height: 1.15; }

    a { text-decoration: none; }
    a:hover { text-decoration: underline; }

    .card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 1rem;
      margin: 1rem 0;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 0.75rem;
    }

    .span2 { grid-column: span 2; }
    .span3 { grid-column: span 3; }
    .span6 { grid-column: span 6; }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    input, select, button {
      width: 100%;
      padding: 0.55rem;
      font-size: 1rem;
    }

    button { cursor: pointer; }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    .muted { color: #555; }

    @media (max-width: 720px) {
      .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .span2, .span3, .span6 { grid-column: span 2; }
    }
  </style>
</head>

<body>

<h1>Moon Phase Calculator</h1>
<p><a href="./">← Mythos and Monarchs</a></p>

<div class="card">
  <h2>Historical accuracy</h2>
  <p class="muted">
    This calculator is anchored to a <b>known New Moon in January 1330</b>
    (solar eclipse), avoiding century-scale drift.
    Use <b>Julian</b> dates for medieval England.
  </p>
</div>

<div class="card">
  <h2>Calculate</h2>

  <div class="grid">
    <div class="span3">
      <label>Calendar</label>
      <select id="calendar">
        <option value="julian" selected>Julian (historical England)</option>
        <option value="gregorian">Gregorian (proleptic)</option>
      </select>
    </div>

    <div class="span2">
      <label>Year</label>
      <input id="year" type="number" value="1330">
    </div>

    <div class="span2">
      <label>Month</label>
      <input id="month" type="number" min="1" max="12" value="6">
    </div>

    <div class="span2">
      <label>Day</label>
      <input id="day" type="number" min="1" max="31" value="27">
    </div>

    <div class="span2">
      <label>Hour (UTC)</label>
      <input id="hour" type="number" min="0" max="23" value="12">
    </div>

    <div class="span2">
      <label>Minute (UTC)</label>
      <input id="minute" type="number" min="0" max="59" value="0">
    </div>

    <div class="span6">
      <button id="btn">Compute moon phase</button>
    </div>
  </div>

  <p class="muted">
    Tip: For date-only historical use, keep the default <b>12:00 UTC</b>.
  </p>
</div>

<div class="card">
  <h2>Result</h2>
  <div id="out">Enter a date and compute.</div>
</div>

<script>
  /* =======================
     Constants & helpers
     ======================= */

  const SYNODIC_MONTH = 29.530588853;

  // New Moon anchor: 1330-01-19 (Julian), annular solar eclipse
  // UT ≈ 21:21:39
  const ANCHOR = {
    year: 1330, month: 1, day: 19,
    hour: 21, minute: 21, second: 39,
    calendar: "julian"
  };

  function mod(n, m) {
    return ((n % m) + m) % m;
  }

  function deg2rad(d) {
    return d * Math.PI / 180;
  }

  /* =======================
     Calendar → Julian Day
     ======================= */

  function julianDay(y, m, d, h, min, s, cal) {
    let Y = y, M = m;
    if (M <= 2) { Y--; M += 12; }

    const A = Math.floor(Y / 100);
    const B = (cal === "gregorian")
      ? 2 - A + Math.floor(A / 4)
      : 0;

    const frac = (h + min / 60 + s / 3600) / 24;

    return Math.floor(365.25 * (Y + 4716))
         + Math.floor(30.6001 * (M + 1))
         + d + frac + B - 1524.5;
  }

  /* =======================
     Anchored phase solver
     ======================= */

  function computePhase(input) {
    const JD = julianDay(
      input.year, input.month, input.day,
      input.hour, input.minute, 0,
      input.calendar
    );

    const epochJD = julianDay(
      ANCHOR.year, ANCHOR.month, ANCHOR.day,
      ANCHOR.hour, ANCHOR.minute, ANCHOR.second,
      ANCHOR.calendar
    );

    const ageDays = mod(JD - epochJD, SYNODIC_MONTH);
    const angle = 360 * (ageDays / SYNODIC_MONTH);
    const illumination = 0.5 * (1 - Math.cos(deg2rad(angle)));

    return { JD, ageDays, angle, illumination };
  }

  function phaseName(angle) {
    const bins = [
      "New Moon",
      "Waxing Crescent",
      "First Quarter",
      "Waxing Gibbous",
      "Full Moon",
      "Waning Gibbous",
      "Last Quarter",
      "Waning Crescent"
    ];
    return bins[Math.floor(mod(angle + 22.5, 360) / 45)];
  }

  /* =======================
     UI
     ======================= */

  const $ = id => document.getElementById(id);

  function render() {
    const input = {
      calendar: $("calendar").value,
      year: +$("year").value,
      month: +$("month").value,
      day: +$("day").value,
      hour: +$("hour").value,
      minute: +$("minute").value
    };

    const r = computePhase(input);

    $("out").innerHTML = `
      <div><b>${phaseName(r.angle)}</b></div>
      <div>Illumination: <span class="mono">${(r.illumination * 100).toFixed(1)}%</span></div>
      <div>Phase angle: <span class="mono">${r.angle.toFixed(1)}°</span> (0° = New, 180° = Full)</div>
      <div>Moon age: <span class="mono">${r.ageDays.toFixed(2)}</span> days</div>
      <div class="muted">
        JD: <span class="mono">${r.JD.toFixed(5)}</span> ·
        Calendar: <span class="mono">${input.calendar}</span> ·
        UTC: <span class="mono">${String(input.hour).padStart(2,"0")}:${String(input.minute).padStart(2,"0")}</span>
      </div>
      <div class="muted">
        Accuracy: best within the 13th–14th centuries (epoch-anchored)
      </div>
    `;
  }

  $("btn").addEventListener("click", render);
  render();
</script>

</body>
</html>
